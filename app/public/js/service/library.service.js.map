{"version":3,"sources":["../../src/ts/service/library.service.ts"],"names":[],"mappings":"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","file":"library.service.js","sourcesContent":["import { Injectable } from '@angular/core';\r\n\r\nimport 'rxjs/add/operator/toPromise';\r\n\r\nimport { RequestOptions, Headers } from '@angular/http';\r\nimport { AppHttp } from '../data/app-http';\r\n\r\nimport { Package } from '../model/package';\r\nimport { MaterialItem, MaterialItemVersion } from '../model/material-item';\r\nimport { Subscription } from '../model/subscription';\r\nimport { Team } from '../model/team';\r\n\r\nimport { User } from '../model/user';\r\nimport { UserService } from './user.service';\r\n\r\n@Injectable()\r\nexport class LibraryService {\r\n    private packageUrl = '/api/package';\r\n    private materialsUrl = '/api/material/';\r\n    private ownedMaterialsUrl = '/api/user/:_id/materials';\r\n\r\n    private subscriptions: Subscription[];\r\n    private packages: Package[];\r\n\r\n    private materials: MaterialItem[];\r\n    private teams: Team[];\r\n    private adminTeams: Team[];\r\n\r\n    constructor(\r\n        private http: AppHttp,\r\n        private userService: UserService\r\n        ) { }\r\n\r\n    private _packagePromise: Promise<Package[]>;\r\n    private _getPackages(): Promise<Package[]> {\r\n        if (!this._packagePromise) {\r\n            this._packagePromise = this.http.get(this.packageUrl)\r\n                .toPromise()\r\n                .then(response => {\r\n                    this.packages = response.json() as Package[];\r\n                    return this.packages;\r\n                })\r\n                .catch(this.handleError);\r\n        }\r\n        return this._packagePromise;\r\n    }\r\n\r\n    /**\r\n     * Get all available packages\r\n     * @param type filter by a specific type (facilitator or improviser)\r\n     * @param team filter by team-oriented packages or individual packages\r\n     */\r\n    getPackages(type?: string, team?: boolean): Promise<Package[]> {\r\n        return new Promise<Package[]>((resolve, reject) => {\r\n            this._getPackages().then(allPackages => {\r\n                if (type != undefined || team != undefined) {\r\n                    let selectedPackages = [];\r\n                    allPackages.forEach(p => {\r\n                        if ((team == undefined || p.team == team) &&\r\n                            (type == undefined || p.type == type)) {\r\n                                selectedPackages.push(p);\r\n                            }\r\n                    });\r\n                    resolve(selectedPackages);\r\n                } else {\r\n                    resolve(allPackages);\r\n                }\r\n            })\r\n        })\r\n    }\r\n\r\n    getOwnedMaterials(): Promise<MaterialItem[]> {\r\n        return new Promise<MaterialItem[]>((res, rej) => {\r\n            this.userService.fetchMaterials().then(user => {\r\n                res(user.materials);\r\n            });\r\n        });\r\n    }\r\n\r\n    getTeamMaterials(): Promise<Team[]> {\r\n        return new Promise<Team[]>((res, rej) => {\r\n            this.userService.fetchMaterials().then(user => {\r\n                res(<Team[]> user.memberOfTeams);\r\n            });\r\n        });\r\n    }\r\n\r\n    getAdminTeamMaterials(): Promise<Team[]> {\r\n        return new Promise<Team[]>((res, rej) => {\r\n            this.userService.fetchMaterials().then(user => {\r\n                res(<Team[]> user.adminOfTeams);\r\n            });\r\n        });\r\n    }\r\n\r\n    downloadMaterial(id: string): void {\r\n        this.http.get(this.materialsUrl + id)\r\n            .toPromise()\r\n            .then(response => {\r\n                let url = response.json().url;\r\n                window.open(location.origin + url);\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Util method to sort a material item's versions\r\n     * @param m the material item to find the latest version for\r\n     */\r\n    getLatestVersionForMaterialItem(m: MaterialItem): MaterialItemVersion {\r\n        m.versions.sort((a, b) => {\r\n            return b.ver - a.ver;\r\n        });\r\n        return m.versions[0];\r\n    }\r\n\r\n    // this is for admin - perhaps admin items should live in their own service?\r\n    getAllMaterials(): Promise<MaterialItem[]> {\r\n        return this.http.get(this.materialsUrl + 'all')\r\n            .toPromise()\r\n            .then(response => {\r\n                return response.json() as MaterialItem[];\r\n            });\r\n    }\r\n\r\n    saveMaterial(material: MaterialItem): Promise<MaterialItem> {\r\n        if (!this.userService.isSuperAdmin()) {\r\n            return;\r\n        }\r\n        return this.http.put(this.materialsUrl + material._id, material)\r\n            .toPromise()\r\n            .then(response => {\r\n                return response.json() as MaterialItem;\r\n            });\r\n    }\r\n\r\n    postNewVersion(materialItemId: string, version: MaterialItemVersion, file: File): Promise<MaterialItem> {\r\n        if (!this.userService.isSuperAdmin()) {\r\n            return;\r\n        }\r\n\r\n        let formData = new FormData();\r\n        formData.append('ver', version.ver);\r\n        formData.append('description', version.description);\r\n        formData.append('file', file, file.name);\r\n\r\n        return this.http.postFormData(this.materialsUrl + materialItemId + '/version', formData).toPromise()\r\n            .then(response => {\r\n                return response.json() as MaterialItem;\r\n            });\r\n    }\r\n\r\n    deleteVersion(materialItemId: string, version: MaterialItemVersion): Promise<MaterialItem> {\r\n        if (!this.userService.isSuperAdmin()) {\r\n            return;\r\n        }\r\n\r\n        return this.http.delete(this.materialsUrl + materialItemId + '/version/' + version._id).toPromise()\r\n            .then(response => {\r\n                return response.json() as MaterialItem;\r\n            });\r\n    }\r\n\r\n    private handleError(error: any): Promise<any> {\r\n        console.error('An error has occurred', error);\r\n        return Promise.reject(error.message || error);\r\n    }\r\n}"]}